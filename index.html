<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>皇室战争记牌器 · 2025 Deepgram 专业版</title>
<style>
    body{font-family:"Microsoft YaHei",Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:15px;min-height:100vh;color:#fff;position:relative}
    .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:20px}
    .main{background:rgba(255,255,255,0.16);backdrop-filter:blur(15px);border-radius:22px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
    h1{text-align:center;margin:0 0 15px;text-shadow:0 2px 10px rgba(0,0,0,0.5)}
    .controls{text-align:center;margin-bottom:20px}
    button{padding:12px 24px;margin:4px;font-size:16px;border:none;border-radius:50px;cursor:pointer;transition:all .3s;font-weight:bold}
    #startBtn{background:#28a745}#stopBtn{background:#dc3545}#undoBtn{background:#6c757d}#resetBtn{background:#ffc107;color:#212529}
    #connectBtn{background:#007bff;color:#fff}
    button:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.4)}
    button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    
    /* API Key 输入区域 */
    .api-section{background:rgba(255,255,255,0.15);border-radius:15px;padding:18px;margin-bottom:20px;text-align:center}
    .api-input{width:85%;padding:12px;border-radius:12px;border:none;font-size:15px;margin:8px 0}
    .api-status{font-size:14px;margin-top:8px;opacity:0.9}

    .status{text-align:center;padding:18px;background:rgba(0,0,0,0.35);border-radius:15px;font-size:19px;margin-bottom:20px;line-height:1.5}
    .slots{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
    .slot{height:135px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;text-shadow:0 2px 10px rgba(0,0,0,0.6);box-shadow:0 8px 25px rgba(0,0,0,0.5)}
    .used{background:linear-gradient(135deg,#ff5e5e,#ff304f)}
    .library{background:linear-gradient(135deg,#00d2ff,#0099ff)}
    
    .atlas{background:rgba(255,255,255,0.16);backdrop-filter:blur(15px);border-radius:22px;padding:20px;height:fit-content;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
    .atlas h2{text-align:center;margin:0 0 15px}
    .search{width:100%;padding:14px;margin-bottom:15px;border-radius:15px;border:none;font-size:16px}
    .card-list{display:grid;grid-template-columns:repeat(3,1fr);gap:11px}
    .card-btn{background:rgba(255,255,255,0.25);border:none;border-radius:12px;padding:12px 8px;font-size:14px;cursor:pointer;transition:all .2s}
    .card-btn:hover{background:rgba(255,255,255,0.45);transform:scale(1.08)}

    /* 底部实时弹窗 */
    #toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:#fff;padding:16px 36px;border-radius:50px;font-size:22px;font-weight:bold;box-shadow:0 12px 35px rgba(0,0,0,0.6);backdrop-filter:blur(12px);z-index:9999;opacity:0;transition:all 0.4s cubic-bezier(0.68,-0.55,0.27,1.55);pointer-events:none;border:2px solid rgba(255,255,255,0.2)}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(-15px)}
</style>
</head>
<body>
<div class="container">
    <div class="main">
        <h1>皇室战争记牌器 2025 Deepgram 专业版</h1>
        
        <!-- Deepgram API Key 输入区域 -->
        <div class="api-section">
            <div style="font-size:18px;margin-bottom:10px">Deepgram API Key</div>
            <input type="password" class="api-input" id="apiKeyInput" placeholder="点击输入您的 Deepgram API Key">
            <div style="margin:10px 0">
                <button id="connectBtn">连接 Deepgram</button>
            </div>
            <div class="api-status" id="apiStatus">未连接</div>
        </div>

        <div class="controls">
            <button id="startBtn" disabled>开始实时监听</button>
            <button id="stopBtn" disabled>停止监听</button>
            <button id="undoBtn" disabled>撤销上一张</button>
            <button id="resetBtn">清空卡槽</button>
        </div>

        <div class="status" id="status">
            请先输入 API Key 并点击“连接 Deepgram”<br>
            连接成功后即可开始语音识别
        </div>
        <div class="slots" id="slots"></div>
    </div>

    <div class="atlas">
        <h2>卡牌图鉴（点我补录）</h2>
        <input type="text" class="search" placeholder="搜索卡牌名称…" id="searchInput">
        <div class="card-list" id="cardList"></div>
    </div>
</div>

<!-- 实时识别弹窗 -->
<div id="toast"></div>

<script src="https://unpkg.com/@deepgram/sdk@3/dist/browser.js"></script>
<script>
// ==================== 全卡牌库与别名表（同前）===================
const allCards = ["骑士","弓箭手","哥布林","炸弹兵","骷髅兵","野蛮人","亡灵","烈焰精灵","蝙蝠","迷你皮卡","哥布林团伙","野蛮人精锐","皇家卫队","重甲亡灵","皇家巨人","哥布林投矛手","骷髅飞龙","冰雪精灵","绿林团伙","烟花炮手","火枪手","瓦基丽武神","野猪骑士","三个火枪手","吹箭哥布林","治疗精灵","飞龙宝宝","骷髅军团","女巫","气球兵","黑暗王子","王子","哥布林巨人","猎人","雷电飞龙","骷髅守卫","巨石投手","飞斧屠夫","加农炮战车","掘地矿工","公主","超级骑士","寒冰法师","地狱飞龙","蛮羊骑士","熔岩猎犬","闪电法师","电磁炮","皇家幽灵","神箭游侠","幻影刺客","暗夜女巫","狂暴樵夫","女巫婆婆","渔夫","弓箭女皇","黄金圣骑","骷髅帝王","皇家塔公主","炮兵","飞刀女爵","皇家大厨","万箭齐发","电击法术","大雪球","皇家速递","火球","火箭","地震法术","野蛮人滚桶","哥布林飞桶","雷电法术","冰冻法术","伤害药水法术","镜像法术","狂暴法术","克隆法术","飓风法术","滚木","骷髅召唤","加农炮","迫击炮","特斯拉电磁塔","哥布林牢笼","骷髅墓碑","地狱之塔","哥布林小屋","烈焰熔炉","炸弹塔","圣水收集器","野蛮人小屋","十字连弩","哥布林钻机","法师","巨人","攻城炸弹人","皮卡超人","戈仑石人","战斗天使","皇家野猪","电击车小队","圣水戈仑","骷髅气球","骷髅巨人","飞行器"];

const aliasMap = {"皮卡":"皮卡超人","逼卡":"皮卡超人","pika":"皮卡超人","皮卡丘":"皮卡超人","皮卡超":"皮卡超人","矿":"掘地矿工","矿工":"掘地矿工","老矿":"掘地矿工","墓园":"骷髅墓碑","墓地":"骷髅墓碑","坟":"骷髅墓碑","石头":"戈仑石人","戈仑":"戈仑石人","狗球":"戈仑石人","石":"戈仑石人","宝宝":"飞龙宝宝","小龙":"飞龙宝宝","飞龙":"飞龙宝宝","大电":"雷电法术","闪电":"雷电法术","电击":"雷电法术","箭雨":"万箭齐发","小箭雨":"万箭齐发","三枪":"三个火枪手","火枪":"三个火枪手","火枪手":"三个火枪手","超骑":"超级骑士","骑士超":"超级骑士","樵夫":"狂暴樵夫","狂暴樵夫":"狂暴樵夫","气球":"气球兵","球":"气球兵","冰法":"寒冰法师","火法":"闪电法师"};

let slots = [], deepgramLive = null, mediaStream = null, lastAddTime = 0, deepgramClient = null;
const toast = document.getElementById('toast');

// 实时弹窗
function showToast(text) {
    toast.textContent = text.length > 30 ? text.substring(0, 30) + '…' : text;
    toast.classList.add('show');
    clearTimeout(toast.timer);
    toast.timer = setTimeout(() => toast.classList.remove('show'), 3000);
}

// 卡槽管理
function updateSlots(){ const s=document.getElementById('slots');s.innerHTML='';for(let i=0;i<8;i++){const d=document.createElement('div');d.className=`slot ${i<4?'used':'library'}`;d.textContent=slots[i]||(i<4?`已用 ${i+1}`:`卡组 ${i+5}`);s.appendChild(d);} document.getElementById('undoBtn').disabled=slots.length===0;}
function addCard(name){ const now=Date.now(); if(now-lastAddTime<600)return; if(slots[0]===name)return; slots.unshift(name); if(slots.length>8)slots.pop(); lastAddTime=now; showToast(name); updateSlots();}
function renderAtlas(f=''){const l=document.getElementById('cardList');l.innerHTML='';allCards.filter(c=>c.includes(f)).forEach(c=>{const b=document.createElement('button');b.className='card-btn';b.textContent=c;b.onclick=()=>addCard(c);l.appendChild(b);});}
document.getElementById('searchInput').addEventListener('input',e=>renderAtlas(e.target.value));
renderAtlas();

// ==================== API Key 输入与连接逻辑 ====================
const apiKeyInput = document.getElementById('apiKeyInput');
const apiStatus = document.getElementById('apiStatus');
const connectBtn = document.getElementById('connectBtn');

// 自动加载上次保存的 Key
const savedKey = localStorage.getItem('deepgram_api_key');
if (savedKey) { apiKeyInput.value = savedKey; connectBtn.textContent = '重新连接'; }

connectBtn.onclick = () => {
    const key = apiKeyInput.value.trim();
    if (!key) { apiStatus.textContent = '请输入 API Key'; apiStatus.style.color = '#ff6b6b'; return; }

    connectBtn.disabled = true;
    connectBtn.textContent = '连接中...';
    apiStatus.textContent = '正在验证密钥...';
    apiStatus.style.color = '#ffd93d';

    try {
        deepgramClient = new window.Deepgram(key);
        // 简单测试连接
        deepgramClient.listen.live({model: 'nova-3'}).then(() => {
            localStorage.setItem('deepgram_api_key', key);
            apiStatus.textContent = 'Deepgram 已连接成功！';
            apiStatus.style.color = '#6bcf7f';
            connectBtn.textContent = '已连接';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('status').innerHTML = 'Deepgram 已就绪<br>点击“开始实时监听”即可使用';
        }).catch(err => {
            apiStatus.textContent = '密钥无效或网络错误';
            apiStatus.style.color = '#ff6b6b';
            connectBtn.disabled = false;
            connectBtn.textContent = '连接 Deepgram';
        });
    } catch (e) {
        apiStatus.textContent = '连接失败';
        apiStatus.style.color = '#ff6b6b';
        connectBtn.disabled = false;
        connectBtn.textContent = '连接 Deepgram';
    }
};

// ==================== 语音监听 ====================
document.getElementById('startBtn').onclick = async () => {
    if (!deepgramClient) { alert('请先连接 Deepgram'); return; }
    try { mediaStream = await navigator.mediaDevices.getUserMedia({audio: true}); }
    catch(err){ document.getElementById('status').innerHTML='麦克风权限被拒绝！请允许后重试'; return; }

    deepgramLive = await deepgramClient.listen.live({punctuate: true, language: 'zh', model: 'nova-3', interim_results: false});

    deepgramLive.addListener('transcript', data => {
        if (data.isFinal && data.channel?.alternatives[0]?.transcript) {
            let text = data.channel.alternatives[0].transcript.replace(/[^\u4e00-\u9fa5]/g, '').trim();
            if (!text) return;
            const real = aliasMap[text] || text;
            const matched = allCards.find(c => c.includes(real) || real.includes(c));
            if (matched) addCard(matched);
        }
    });

    deepgramLive.start(mediaStream);
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('status').innerHTML = '实时监听已启动！<br>说出卡牌 → 底部弹窗提示';
};

document.getElementById('stopBtn').onclick = () => {
    if (deepgramLive) { deepgramLive.finish(); deepgramLive = null; }
    if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('status').textContent = '已停止监听';
};

document.getElementById('undoBtn').onclick = () => {slots.shift(); updateSlots();};
document.getElementById('resetBtn').onclick = () => {slots=[]; updateSlots();};
updateSlots();
</script>
</body>
</html>
