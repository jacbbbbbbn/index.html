// ...（前文不变，直至processResult函数）

// 改进的识别结果处理：支持中文断句检测与匹配
function processResult(text) {
  transcriptBuffer += text + ' ';
  if (transcriptBuffer.length > MAX_BUFFER_LENGTH) {
    transcriptBuffer = transcriptBuffer.slice(-MAX_BUFFER_LENGTH);
  }
  speechText.textContent = transcriptBuffer.trim();
  // 清理标点并转换为小写以便匹配（针对别名）
  const cleanText = transcriptBuffer.replace(/[，。！？；：、（）()""''，]/g, ' ').replace(/\s+/g, ' ').trim().toLowerCase();
  console.log('识别文本（清理后）:', cleanText); // 调试日志
  
  // 扩展所有可能匹配项（卡牌 + 别名）
  const allMatches = [...new Set([...allCards.map(c => c.toLowerCase()), ...Object.keys(aliasMap).map(k => k.toLowerCase()), ...Object.values(aliasMap).map(v => v.toLowerCase())])];
  
  // 子串匹配：遍历cleanText，查找连续匹配
  for (let i = 0; i < cleanText.length; i++) {
    for (let match of allMatches) {
      if (cleanText.indexOf(match) !== -1) { // 简单包含匹配，避免词边界问题
        const detectedCard = allCards.find(c => c.toLowerCase() === match) || 
                             Object.values(aliasMap).find(v => v.toLowerCase() === match) || 
                             aliasMap[Object.keys(aliasMap).find(k => k.toLowerCase() === match)] || match;
        // 检查是否为有效卡牌
        const validCards = slots.length >= 8 ? slots : allCards;
        if (validCards.some(c => c.toLowerCase() === detectedCard.toLowerCase())) {
          console.log('匹配成功:', detectedCard); // 调试日志
          addCard(detectedCard, '语音');
          transcriptBuffer = ''; // 清空缓冲，避免重复
          speechText.textContent = '';
          return; // 只添加一张
        }
      }
    }
  }
}

// ...（后文不变）
