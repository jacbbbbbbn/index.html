<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çš‡å®¤æˆ˜äº‰è®°ç‰Œå™¨ Â· 2025 Deepgram ä¼˜åŒ–ç‰ˆ</title>
<style>
    body{font-family:"Microsoft YaHei",Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:15px;min-height:100vh;color:#fff;position:relative}
    .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:20px}
    .main{background:rgba(255,255,255,0.16);backdrop-filter:blur(15px);border-radius:22px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
    h1{text-align:center;margin:0 0 15px;text-shadow:0 2px 10px rgba(0,0,0,0.5)}
    .api-section{background:rgba(255,255,255,0.15);border-radius:15px;padding:18px;margin-bottom:20px;text-align:center;position:relative}
    .api-input{width:78%;padding:12px;border-radius:12px;border:none;font-size:15px;margin:8px 0}
    .eye-toggle{position:absolute;right:60px;top:52px;cursor:pointer;font-size:18px;opacity:0.7}
    button{padding:12px 24px;margin:4px;font-size:16px;border:none;border-radius:50px;cursor:pointer;transition:all .3s;font-weight:bold}
    #startBtn{background:#28a745}#stopBtn{background:#dc3545}#undoBtn{background:#6c757d}#resetBtn{background:#ffc107;color:#212529}
    #connectBtn{background:#007bff;color:#fff}#reloadSdkBtn{background:#17a2b8;color:#fff}
    button:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.4)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .api-status{font-size:14px;margin-top:8px;opacity:0.9}
    .status{text-align:center;padding:18px;background:rgba(0,0,0,0.35);border-radius:15px;font-size:19px;margin-bottom:20px;line-height:1.5}
    .slots{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
    .slot{height:135px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;text-shadow:0 2px 10px rgba(0,0,0,0.6);box-shadow:0 8px 25px rgba(0,0,0,0.5)}
    .used{background:linear-gradient(135deg,#ff5e5e,#ff304f)}
    .library{background:linear-gradient(135deg,#00d2ff,#0099ff)}
    .atlas{background:rgba(255,255,255,0.16);backdrop-filter:blur(15px);border-radius:22px;padding:20px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
    .search{width:100%;padding:14px;margin-bottom:15px;border-radius:15px;border:none;font-size:16px}
    .card-list{display:grid;grid-template-columns:repeat(3,1fr);gap:11px}
    .card-btn{background:rgba(255,255,255,0.25);border:none;border-radius:12px;padding:12px 8px;font-size:14px;cursor:pointer;transition:all .2s}
    .card-btn:hover{background:rgba(255,255,255,0.45);transform:scale(1.08)}
    #toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:#fff;padding:16px 36px;border-radius:50px;font-size:22px;font-weight:bold;box-shadow:0 12px 35px rgba(0,0,0,0.6);backdrop-filter:blur(12px);z-index:9999;opacity:0;transition:all 0.4s cubic-bezier(0.68,-0.55,0.27,1.55);pointer-events:none;border:2px solid rgba(255,255,255,0.2)}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(-15px)}
</style>
</head>
<body>
<div class="container">
    <div class="main">
        <h1>çš‡å®¤æˆ˜äº‰è®°ç‰Œå™¨ 2025 Deepgram ä¼˜åŒ–ç‰ˆ</h1>
        
        <div class="api-section">
            <div style="font-size:18px;margin-bottom:10px">Deepgram API Key</div>
            <div style="position:relative;display:inline-block">
                <input type="text" class="api-input" id="apiKeyInput" placeholder="ç²˜è´´æ‚¨çš„ Deepgram Key">
                <span class="eye-toggle" id="eyeToggle">ğŸ‘ï¸</span>
            </div>
            <div style="margin:10px 0">
                <button id="connectBtn">è¿æ¥ Deepgram</button>
                <button id="reloadSdkBtn">é‡è½½ SDK</button>
            </div>
            <div class="api-status" id="apiStatus">æœªè¿æ¥</div>
        </div>

        <div class="controls">
            <button id="startBtn" disabled>å¼€å§‹å®æ—¶ç›‘å¬</button>
            <button id="stopBtn" disabled>åœæ­¢ç›‘å¬</button>
            <button id="undoBtn" disabled>æ’¤é”€ä¸Šä¸€å¼ </button>
            <button id="resetBtn">æ¸…ç©ºå¡æ§½</button>
        </div>

        <div class="status" id="status">è¯·å…ˆè¾“å…¥ API Key å¹¶è¿æ¥ Deepgram</div>
        <div class="slots" id="slots"></div>
    </div>

    <div class="atlas">
        <h2>å¡ç‰Œå›¾é‰´ï¼ˆç‚¹æˆ‘è¡¥å½•ï¼‰</h2>
        <input type="text" class="search" placeholder="æœç´¢å¡ç‰Œâ€¦" id="searchInput">
        <div class="card-list" id="cardList"></div>
    </div>
</div>

<div id="toast"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@deepgram/sdk@3.2.0/+esm';

// å…¨å±€æš´éœ²
window.createDeepgramClient = createClient;

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('status').textContent = 'SDK åŠ è½½å®Œæˆï¼Œè¯·è¾“å…¥å¯†é’¥è¿æ¥';
});

// å¡ç‰Œåº“ä¸åˆ«åè¡¨
const allCards = ["éª‘å£«","å¼“ç®­æ‰‹","å“¥å¸ƒæ—","ç‚¸å¼¹å…µ","éª·é«…å…µ","é‡è›®äºº","äº¡çµ","çƒˆç„°ç²¾çµ","è™è ","è¿·ä½ çš®å¡","å“¥å¸ƒæ—å›¢ä¼™","é‡è›®äººç²¾é”","çš‡å®¶å«é˜Ÿ","é‡ç”²äº¡çµ","çš‡å®¶å·¨äºº","å“¥å¸ƒæ—æŠ•çŸ›æ‰‹","éª·é«…é£é¾™","å†°é›ªç²¾çµ","ç»¿æ—å›¢ä¼™","çƒŸèŠ±ç‚®æ‰‹","ç«æªæ‰‹","ç“¦åŸºä¸½æ­¦ç¥","é‡çŒªéª‘å£«","ä¸‰ä¸ªç«æªæ‰‹","å¹ç®­å“¥å¸ƒæ—","æ²»ç–—ç²¾çµ","é£é¾™å®å®","éª·é«…å†›å›¢","å¥³å·«","æ°”çƒå…µ","é»‘æš—ç‹å­","ç‹å­","å“¥å¸ƒæ—å·¨äºº","çŒäºº","é›·ç”µé£é¾™","éª·é«…å®ˆå«","å·¨çŸ³æŠ•æ‰‹","é£æ–§å± å¤«","åŠ å†œç‚®æˆ˜è½¦","æ˜åœ°çŸ¿å·¥","å…¬ä¸»","è¶…çº§éª‘å£«","å¯’å†°æ³•å¸ˆ","åœ°ç‹±é£é¾™","è›®ç¾Šéª‘å£«","ç†”å²©çŒçŠ¬","é—ªç”µæ³•å¸ˆ","ç”µç£ç‚®","çš‡å®¶å¹½çµ","ç¥ç®­æ¸¸ä¾ ","å¹»å½±åˆºå®¢","æš—å¤œå¥³å·«","ç‹‚æš´æ¨µå¤«","å¥³å·«å©†å©†","æ¸”å¤«","å¼“ç®­å¥³çš‡","é»„é‡‘åœ£éª‘","éª·é«…å¸ç‹","çš‡å®¶å¡”å…¬ä¸»","ç‚®å…µ","é£åˆ€å¥³çˆµ","çš‡å®¶å¤§å¨","ä¸‡ç®­é½å‘","ç”µå‡»æ³•æœ¯","å¤§é›ªçƒ","çš‡å®¶é€Ÿé€’","ç«çƒ","ç«ç®­","åœ°éœ‡æ³•æœ¯","é‡è›®äººæ»šæ¡¶","å“¥å¸ƒæ—é£æ¡¶","é›·ç”µæ³•æœ¯","å†°å†»æ³•æœ¯","ä¼¤å®³è¯æ°´æ³•æœ¯","é•œåƒæ³•æœ¯","ç‹‚æš´æ³•æœ¯","å…‹éš†æ³•æœ¯","é£“é£æ³•æœ¯","æ»šæœ¨","éª·é«…å¬å”¤","åŠ å†œç‚®","è¿«å‡»ç‚®","ç‰¹æ–¯æ‹‰ç”µç£å¡”","å“¥å¸ƒæ—ç‰¢ç¬¼","éª·é«…å¢“ç¢‘","åœ°ç‹±ä¹‹å¡”","å“¥å¸ƒæ—å°å±‹","çƒˆç„°ç†”ç‚‰","ç‚¸å¼¹å¡”","åœ£æ°´æ”¶é›†å™¨","é‡è›®äººå°å±‹","åå­—è¿å¼©","å“¥å¸ƒæ—é’»æœº","æ³•å¸ˆ","å·¨äºº","æ”»åŸç‚¸å¼¹äºº","çš®å¡è¶…äºº","æˆˆä»‘çŸ³äºº","æˆ˜æ–—å¤©ä½¿","çš‡å®¶é‡çŒª","ç”µå‡»è½¦å°é˜Ÿ","åœ£æ°´æˆˆä»‘","éª·é«…æ°”çƒ","éª·é«…å·¨äºº","é£è¡Œå™¨"];

const aliasMap = {"çš®å¡":"çš®å¡è¶…äºº","é€¼å¡":"çš®å¡è¶…äºº","pika":"çš®å¡è¶…äºº","çš®å¡ä¸˜":"çš®å¡è¶…äºº","çš®å¡è¶…":"çš®å¡è¶…äºº","çŸ¿":"æ˜åœ°çŸ¿å·¥","çŸ¿å·¥":"æ˜åœ°çŸ¿å·¥","è€çŸ¿":"æ˜åœ°çŸ¿å·¥","å¢“å›­":"éª·é«…å¢“ç¢‘","å¢“åœ°":"éª·é«…å¢“ç¢‘","åŸ":"éª·é«…å¢“ç¢‘","çŸ³å¤´":"æˆˆä»‘çŸ³äºº","æˆˆä»‘":"æˆˆä»‘çŸ³äºº","ç‹—çƒ":"æˆˆä»‘çŸ³äºº","çŸ³":"æˆˆä»‘çŸ³äºº","å®å®":"é£é¾™å®å®","å°é¾™":"é£é¾™å®å®","é£é¾™":"é£é¾™å®å®","å¤§ç”µ":"é›·ç”µæ³•æœ¯","é—ªç”µ":"é›·ç”µæ³•æœ¯","ç”µå‡»":"é›·ç”µæ³•æœ¯","ç®­é›¨":"ä¸‡ç®­é½å‘","å°ç®­é›¨":"ä¸‡ç®­é½å‘","ä¸‰æª":"ä¸‰ä¸ªç«æªæ‰‹","ç«æª":"ä¸‰ä¸ªç«æªæ‰‹","ç«æªæ‰‹":"ä¸‰ä¸ªç«æªæ‰‹","è¶…éª‘":"è¶…çº§éª‘å£«","éª‘å£«è¶…":"è¶…çº§éª‘å£«","æ¨µå¤«":"ç‹‚æš´æ¨µå¤«","ç‹‚æš´æ¨µå¤«":"ç‹‚æš´æ¨µå¤«","æ°”çƒ":"æ°”çƒå…µ","çƒ":"æ°”çƒå…µ","å†°æ³•":"å¯’å†°æ³•å¸ˆ","ç«æ³•":"é—ªç”µæ³•å¸ˆ"};

let slots = [], deepgramClient = null, deepgramLive = null, mediaStream = null, lastAddTime = 0;
const toast = document.getElementById('toast');

// UI å‡½æ•°
function showToast(t){toast.textContent=t.length>30?t.substring(0,30)+'â€¦':t;toast.classList.add('show');clearTimeout(toast.timer);toast.timer=setTimeout(()=>toast.classList.remove('show'),3000);}
function updateSlots(){const s=document.getElementById('slots');s.innerHTML='';for(let i=0;i<8;i++){const d=document.createElement('div');d.className=`slot ${i<4?'used':'library'}`;d.textContent=slots[i]||(i<4?`å·²ç”¨ ${i+1}`:`å¡ç»„ ${i+5}`);s.appendChild(d);}document.getElementById('undoBtn').disabled=slots.length===0;}
function addCard(n){const w=Date.now();if(w-lastAddTime<600)return;if(slots[0]===n)return;slots.unshift(n);if(slots.length>8)slots.pop();lastAddTime=w;showToast(n);updateSlots();}
function renderAtlas(f=''){const l=document.getElementById('cardList');l.innerHTML='';allCards.filter(c=>c.includes(f)).forEach(c=>{const b=document.createElement('button');b.className='card-btn';b.textContent=c;b.onclick=()=>addCard(c);l.appendChild(b);});}
document.getElementById('searchInput').addEventListener('input',e=>renderAtlas(e.target.value));
renderAtlas();

// çœ¼å›¾æ ‡åˆ‡æ¢
document.getElementById('eyeToggle').onclick = () => {
    const input = document.getElementById('apiKeyInput');
    input.type = input.type === 'password' ? 'text' : 'password';
    document.getElementById('eyeToggle').textContent = input.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
};

// é‡è½½ SDK æŒ‰é’®
document.getElementById('reloadSdkBtn').onclick = () => {
    location.reload();
};

// è¿æ¥éªŒè¯
let isConnected = false;
document.getElementById('connectBtn').onclick = async () => {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) { document.getElementById('apiStatus').textContent = 'è¯·è¾“å…¥ API Key'; return; }

    const btn = document.getElementById('connectBtn');
    btn.disabled = true; btn.textContent = 'éªŒè¯ä¸­...';
    const statusEl = document.getElementById('apiStatus');
    statusEl.textContent = 'æ­£åœ¨éªŒè¯å¯†é’¥...';

    try {
        deepgramClient = createDeepgramClient(key);
        const response = await fetch('https://api.deepgram.com/v1/auth/token', {
            method: 'GET',
            headers: { 'Authorization': `Token ${key}` }
        });
        if (response.ok) {
            const data = await response.json();
            localStorage.setItem('deepgram_key', key);
            statusEl.innerHTML = `Deepgram è¿æ¥æˆåŠŸï¼(é¡¹ç›®: ${data.project_id})`;
            statusEl.style.color = '#6bcf7f';
            btn.textContent = 'å·²è¿æ¥';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('status').textContent = 'Deepgram å·²å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹å®æ—¶ç›‘å¬';
            isConnected = true;
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (e) {
        console.error('Deepgram é”™è¯¯è¯¦æƒ…:', e);
        let errorMsg = e.message || 'æœªçŸ¥é”™è¯¯';
        if (errorMsg.includes('401')) errorMsg = '401: æ— æ•ˆå¯†é’¥ï¼Œè¯·æ£€æŸ¥æ‹¼å†™æˆ–ç”Ÿæˆæ–°å¯†é’¥';
        else if (errorMsg.includes('403')) errorMsg = '403: æ— æƒé™è®¿é—®ï¼Œè¯·æ£€æŸ¥é¡¹ç›®è®¾ç½®';
        else if (errorMsg.includes('timeout') || errorMsg.includes('NET')) errorMsg = 'ç½‘ç»œè¶…æ—¶ï¼šæ£€æŸ¥é˜²ç«å¢™/ä»£ç†æˆ– SSL é…ç½®';
        else if (errorMsg.includes('SSL')) errorMsg = 'SSL é”™è¯¯ï¼šç¡®ä¿æµè§ˆå™¨æ”¯æŒ TLS 1.3';
        statusEl.innerHTML = `è¿æ¥å¤±è´¥: ${errorMsg}`;
        statusEl.style.color = '#ff6b6b';
        btn.disabled = false; btn.textContent = 'é‡è¯•è¿æ¥';
    }
};

// è‡ªåŠ¨å¡«å……
const saved = localStorage.getItem('deepgram_key');
if (saved) document.getElementById('apiKeyInput').value = saved;

// å®æ—¶ç›‘å¬
document.getElementById('startBtn').onclick = async () => {
    if (!isConnected) { alert('è¯·å…ˆæˆåŠŸè¿æ¥ Deepgram'); return; }
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: { sampleRate: 16000, channelCount: 1, echoCancellation: true }
        });
    } catch (err) {
        document.getElementById('status').innerHTML = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼è¯·å…è®¸åé‡è¯•';
        return;
    }

    try {
        deepgramLive = await deepgramClient.listen.live({
            punctuate: true,
            language: 'zh',
            model: 'nova-3',
            interim_results: true,
            keepalive: true
        });

        deepgramLive.addListener('transcript', data => {
            if (data.isFinal && data.channel?.alternatives[0]?.transcript) {
                let text = data.channel.alternatives[0].transcript.replace(/[^\u4e00-\u9fa5]/g, '').trim();
                if (!text) return;
                const real = aliasMap[text] || text;
                const matched = allCards.find(c => c.includes(real) || real.includes(c));
                if (matched) addCard(matched);
            }
        });

        deepgramLive.addListener('error', e => {
            console.error('Deepgram æµé”™è¯¯:', e);
            document.getElementById('status').textContent = 'æµè¿æ¥å¼‚å¸¸: ' + (e.message || 'æœªçŸ¥');
        });

        deepgramLive.start(mediaStream);
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('status').innerHTML = 'å®æ—¶ç›‘å¬å·²å¯åŠ¨ï¼è¯´å‡ºå¡ç‰Œåç§°';
    } catch (e) {
        console.error('å¯åŠ¨å¤±è´¥:', e);
        document.getElementById('status').textContent = 'å¯åŠ¨å¼‚å¸¸: ' + e.message + ' (å›é€€åˆ° Web Speech API)';
        fallbackToWebSpeech();
    }
};

// Web Speech API å›é€€
function fallbackToWebSpeech() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return;
    const recognition = new SpeechRecognition();
    recognition.lang = 'zh-CN';
    recognition.continuous = true;
    recognition.onresult = e => {
        let text = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
            text += e.results[i][0].transcript;
        }
        text = text.replace(/[^\u4e00-\u9fa5]/g, '').trim();
        if (!text) return;
        const real = aliasMap[text] || text;
        const matched = allCards.find(c => c.includes(real) || real.includes(c));
        if (matched) addCard(matched);
    };
    recognition.start();
    document.getElementById('status').textContent = 'ä½¿ç”¨ Web Speech API å›é€€æ¨¡å¼';
}

document.getElementById('stopBtn').onclick = () => {
    if (deepgramLive) { deepgramLive.finish(); deepgramLive = null; }
    if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('status').textContent = 'å·²åœæ­¢ç›‘å¬';
};

document.getElementById('undoBtn').onclick = () => {slots.shift(); updateSlots();};
document.getElementById('resetBtn').onclick = () => {slots=[]; updateSlots();};
updateSlots();
</script>
</body>
</html>
