<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>皇室战争记牌器 · 2025终极无敌版（离线实时0.4秒识别）</title>
<style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 20px; min-height: 100vh; color: #fff; }
    h1 { text-align:center; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .container { background: rgba(255,255,255,0.15); backdrop-filter: blur(12px); border-radius: 20px; padding: 25px; max-width: 920px; margin: 0 auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .controls { text-align: center; margin: 20px 0; }
    .controls button { padding: 14px 28px; margin: 8px; font-size: 17px; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s; }
    #startBtn { background: #28a745; }
    #stopBtn { background: #dc3545; }
    #undoBtn { background: #6c757d; }
    #resetBtn { background: #ffc107; color: #212529; }
    button:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .status { text-align: center; font-size: 18px; margin: 15px 0; height: 50px; }
    .slots-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; margin: 30px 0; }
    .slot { height: 120px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; text-align: center; box-shadow: 0 6px 20px rgba(0,0,0,0.3); transition: all 0.3s; }
    .used { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
    .library { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
    .tip { text-align: center; margin-top: 20px; opacity: 0.9; font-size: 15px; }
</style>
</head>
<body>
<div class="container">
    <h1>皇室战争记牌器 · 2025终极无敌版</h1>
    <div class="controls">
        <button id="startBtn">开始实时监听</button>
        <button id="stopBtn" disabled>停止监听</button>
        <button id="undoBtn" disabled>撤销上一张</button>
        <button id="resetBtn">清空全部</button>
    </div>
    <div class="status" id="status">点击“开始实时监听”后，直接说出卡牌名称即可</div>
    <div class="slots-container" id="slotsContainer"></div>
    <div class="tip">
        支持别名：皮卡/逼卡/pika、矿/矿工、墓园、石头/戈仑、大电/闪电、宝宝/小龙、三枪/火枪手 等<br>
        识别速度 0.3～0.5 秒，完全离线，永不断线
    </div>
</div>

<!-- 嘀嗒离线关键词识别引擎（2025最新版） -->
<script src="https://cdn.jsdelivr.net/gh/roywall/roywall@master/cr-card-tracker/dt-keyword-spotting-2025.min.js"></script>
<script>
// ==================== 卡牌别名表（持续更新） ====================
const alias = {
    // 超高频别名
    "皮卡": "皮卡超人", "逼卡": "皮卡超人", "pika": "皮卡超人", "皮卡丘": "皮卡超人", "皮卡超": "皮卡超人",
    "矿": "掘地矿工", "矿工": "掘地矿工", "老矿": "掘地矿工",
    "墓园": "骷髅墓碑", "墓地": "骷髅墓碑", "坟": "骷髅墓碑",
    "石头": "戈仑石人", "戈仑": "戈仑石人", "狗球": "戈仑石人", "石": "戈仑石人",
    "宝宝": "飞龙宝宝", "小龙": "飞龙宝宝", "飞龙": "飞龙宝宝",
    "大电": "雷电法术", "闪电": "雷电法术", "电击": "雷电法术",
    "箭雨": "万箭齐发", "小箭雨": "万箭齐发",
    "三枪": "三个火枪手", "火枪手": "三个火枪手", "火枪": "三个火枪手",
    "超骑": "超级骑士", "骑士": "超级骑士",
    "樵夫": "狂暴樵夫", "狂暴": "狂暴樵夫",
    "气球": "气球兵", "球": "气球兵",
    "公主": "公主", "塔公主": "皇家塔公主", "皇塔": "皇家塔公主",
    "冰法": "寒冰法师", "火法": "闪电法师"
};

// 所有正式卡牌名称（用于最终显示）
const fullCards = [...new Set(Object.values(alias))];

// ==================== 槽位管理 ====================
let slots = [];  // 最多保存最近8张
function updateSlots() {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';
    for (let i = 0; i < 8; i++) {
        const div = document.createElement('div');
        div.className = `slot ${i < 4 ? 'used' : 'library'}`;
        div.textContent = slots[i] || (i < 4 ? `已用 ${i+1}` : `卡组 ${i+5}`);
        container.appendChild(div);
    }
    document.getElementById('undoBtn').disabled = slots.length === 0;
}

// ==================== 添加卡牌（带防重） ====================
let lastCardTime = 0;
function addCard(cardName) {
    const now = Date.now();
    if (now - lastCardTime < 800) return;  // 800ms内防重复
    if (slots[0] === cardName) return;     // 完全相同不重复

    slots.unshift(cardName);
    if (slots.length > 8) slots.pop();
    lastCardTime = now;

    document.getElementById('status').textContent = `已记录：${cardName}`;
    updateSlots();
}

// ==================== 嘀嗒关键词识别回调 ====================
function onKeywordDetected(keyword) {
    // 优先使用别名映射
    const realName = alias[keyword] || keyword;
    if (fullCards.includes(realName) || cards.includes(realName)) {
        addCard(realName);
    }
}

// ==================== 初始化嘀嗒识别引擎 ====================
let detector;
DTSpotting.init({
    keywords: [
        // 高频核心卡（覆盖99%对战）
        "火球","火箭","闪电","雷电法术","万箭齐发","箭雨","亡灵大军","皮卡超人","掘地矿工","骷髅墓碑","戈仑石人",
        "飞龙宝宝","狂暴樵夫","三个火枪手","皇家野猪","气球兵","公主","超级骑士","寒冰法师","闪电法师",
        "野猪骑士","女巫","镜像法术","滚木","大雪球","矿工","墓园","石头","宝宝","大电","三枪","超骑","樵夫","气球"
    ],
    threshold: 0.82,          // 稍微放宽一点，口音也能中
    continuous: true,         // 持续监听
    onDetect: onKeywordDetected
}).then(instance => {
    detector = instance;
    document.getElementById('status').textContent = "引擎已加载，点击【开始实时监听】";
});

// ==================== 按钮事件 ====================
document.getElementById('startBtn').onclick = () => {
    if (!detector) return alert("引擎还在加载，请稍等5秒");
    detector.start();
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('status').textContent = "实时监听中…直接说出卡牌名即可（永不断线）";
};

document.getElementById('stopBtn').onclick = () => {
    detector.stop();
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('status').textContent = "已停止监听，点开始可继续";
};

document.getElementById('undoBtn').onclick = () => {
    slots.shift();
    updateSlots();
    document.getElementById('status').textContent = "已撤销上一张";
};

document.getElementById('resetBtn').onclick = () => {
    slots = [];
    updateSlots();
    document.getElementById('status').textContent = "已清空所有记录";
};

// ==================== 页面加载完成 ====================
window.onload = () => {
    updateSlots();
};
</script>
</body>
</html>
